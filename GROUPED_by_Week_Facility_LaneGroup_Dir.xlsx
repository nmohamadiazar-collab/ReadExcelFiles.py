import os
import re
from openpyxl import load_workbook
import pandas as pd

import tkinter as tk
from tkinter import filedialog, messagebox

# ==========================
# SETTINGS (fixed cells)
# ==========================
START_SHEET_NUMBER = 2   # start from sheet #2
CELL_LABEL = "A21"
CELL_VALUE = "Z46"

def extract_week_from_filename(filename: str):
    m = re.search(r"\bweek\s*(\d+)\b", filename, flags=re.IGNORECASE)
    return int(m.group(1)) if m else None

def parse_direction(a21_text: str):
    """Return 'EB', 'WB', or None based on A21."""
    if a21_text is None:
        return None
    s = str(a21_text).upper()
    if re.search(r"\bEB\b|EASTBOUND", s):
        return "EB"
    if re.search(r"\bWB\b|WESTBOUND", s):
        return "WB"
    return None

def parse_lane_group(a21_text: str):
    """
    Try to extract a lane group identifier from A21.
    Supports patterns like:
      'Lane Group 1'
      'LaneGroup 2'
      'LG 3'
      'Group: 4' (fallback)
    Returns string like 'LG1', 'LG2', etc.
    """
    if a21_text is None:
        return None
    s = str(a21_text).upper()

    patterns = [
        r"\bLANE\s*GROUP\s*[:\-]?\s*(\d+)\b",
        r"\bLANEGROUP\s*[:\-]?\s*(\d+)\b",
        r"\bLG\s*[:\-]?\s*(\d+)\b",
        r"\bGROUP\s*[:\-]?\s*(\d+)\b",  # fallback if your A21 uses just "Group"
    ]
    for p in patterns:
        m = re.search(p, s)
        if m:
            return f"LG{m.group(1)}"
    return None

def parse_facility(a21_text: str):
    """
    Extract facility name from A21.
    This is harder because formats vary.
    Strategy:
      1) If "FACILITY:" exists, take text after it (until a separator)
      2) Else, just return cleaned A21 as facility (fallback)
    Then we remove direction/lane-group words from the facility.
    """
    if a21_text is None:
        return None

    raw = str(a21_text).strip()
    upper = raw.upper()

    # Try: "Facility: <name> ..."
    m = re.search(r"FACILITY\s*[:\-]\s*(.+)$", raw, flags=re.IGNORECASE)
    if m:
        facility = m.group(1).strip()
    else:
        facility = raw

    # Clean up common tokens so facility becomes stable
    facility_u = facility.upper()
    facility_u = re.sub(r"\bEB\b|\bWB\b|EASTBOUND|WESTBOUND", " ", facility_u)
    facility_u = re.sub(r"\bLANE\s*GROUP\b|\bLANEGROUP\b|\bLG\b|\bGROUP\b", " ", facility_u)
    facility_u = re.sub(r"[^A-Z0-9 ]+", " ", facility_u)
    facility_u = re.sub(r"\s+", " ", facility_u).strip()

    return facility_u if facility_u else raw

def process_one_file(file_path: str) -> pd.DataFrame:
    wb = load_workbook(file_path, data_only=True)
    sheetnames = wb.sheetnames
    total_sheets = len(sheetnames)

    filename = os.path.basename(file_path)
    week = extract_week_from_filename(filename)

    rows = []
    for sheet_number in range(START_SHEET_NUMBER, total_sheets + 1):
        sheet_name = sheetnames[sheet_number - 1]
        ws = wb[sheet_name]

        a21 = ws[CELL_LABEL].value
        z46 = ws[CELL_VALUE].value

        direction = parse_direction(a21)
        lane_group = parse_lane_group(a21)
        facility = parse_facility(a21)

        rows.append({
            "source_file": filename,
            "week": week,
            "facility": facility,
            "lane_group": lane_group,
            "direction": direction,
            "sheet_number": sheet_number,
            "sheet_name": sheet_name,
            CELL_LABEL: a21,
            CELL_VALUE: z46
        })

    return pd.DataFrame(rows)

def main():
    # Create OUTPUT folder next to this script
    base_dir = os.path.dirname(os.path.abspath(__file__))
    output_dir = os.path.join(base_dir, "OUTPUT")
    os.makedirs(output_dir, exist_ok=True)

    # File picker
    root = tk.Tk()
    root.withdraw()

    file_paths = filedialog.askopenfilenames(
        title="Select Excel file(s) to extract A21 and Z46",
        filetypes=[("Excel files", "*.xlsx *.xlsm")]
    )

    if not file_paths:
        print("No files selected. Exiting.")
        return

    all_results = []

    for file_path in file_paths:
        fname = os.path.basename(file_path)
        print(f"Processing: {fname}")

        try:
            df = process_one_file(file_path)
        except Exception as e:
            print(f"  ERROR reading {fname}: {e}")
            continue

        # Save per-file results (your original behavior)
        base_name = os.path.splitext(fname)[0]
        out_xlsx = os.path.join(output_dir, f"{base_name}_A21_Z46.xlsx")
        out_csv = os.path.join(output_dir, f"{base_name}_A21_Z46.csv")

        df.to_excel(out_xlsx, index=False)
        df.to_csv(out_csv, index=False)

        print(f"  Saved: {out_xlsx}")
        all_results.append(df)

    # Combined + Grouped
    if all_results:
        combined = pd.concat(all_results, ignore_index=True)

        combined_xlsx = os.path.join(output_dir, "ALL_SELECTED_FILES_A21_Z46.xlsx")
        combined_csv = os.path.join(output_dir, "ALL_SELECTED_FILES_A21_Z46.csv")
        combined.to_excel(combined_xlsx, index=False)
        combined.to_csv(combined_csv, index=False)

        # Make Z46 numeric for summing
        combined["Z46_numeric"] = pd.to_numeric(combined[CELL_VALUE], errors="coerce")

        grouped = (
            combined
            .groupby(["week", "facility", "lane_group", "direction"], dropna=False)["Z46_numeric"]
            .sum()
            .reset_index()
            .rename(columns={"Z46_numeric": "Z46_sum"})
        )

        grouped_xlsx = os.path.join(output_dir, "GROUPED_by_Week_Facility_LaneGroup_Dir.xlsx")
        grouped.to_excel(grouped_xlsx, index=False)

        print("\nDONE.")
        print(f"Combined saved: {combined_xlsx}")
        print(f"Grouped saved: {grouped_xlsx}")

        messagebox.showinfo("Done", f"Finished! Outputs saved in:\n{output_dir}")
    else:
        messagebox.showwarning("No output", "No files were processed successfully.")

if __name__ == "__main__":
    main()
